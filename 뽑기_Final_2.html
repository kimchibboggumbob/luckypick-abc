<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>랜덤 뽑기 (공용 잔여 · Netlify Functions)</title>
  <style>
    :root { --fg:#0f172a; --muted:#475569; --bg:#f8fafc; --card:#ffffff; --primary:#2563eb; --border:#e2e8f0; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; color:var(--fg); background:var(--bg); }
    .wrap { max-width: 960px; margin: 40px auto; padding: 24px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow: 0 6px 16px rgba(15, 23, 42, 0.06); overflow:hidden; }
    .card-header { padding: 18px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    h1 { font-size: 20px; margin:0; }
    .card-body { padding: 20px; display:grid; gap:18px; grid-template-columns: 1fr; }
    .row { display:grid; gap:12px; }
    label { font-weight:600; font-size:14px; }
    textarea { width:100%; min-height: 200px; resize:vertical; padding:12px 14px; border:1px solid var(--border); border-radius:12px; font-size:14px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#f8fafc; }
    input[type="number"] { width: 110px; padding:8px 10px; border:1px solid var(--border); border-radius:10px; font-size:13px; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    button { appearance:none; border:1px solid var(--border); background:#fff; color:var(--fg); padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; transition: transform .02s ease; }
    button.primary { background: var(--primary); border-color: var(--primary); color:#fff; }
    button:active { transform: translateY(1px); }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    .muted { color:var(--muted); font-size:13px; }
    .results { background:#fff; border:1px dashed var(--border); border-radius:12px; padding:14px; display:grid; gap:10px; }
    .badge { display:inline-flex; align-items:center; gap:8px; font-size:13px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#f9fafb; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:10px; }
    .empty { padding:12px; text-align:center; color:var(--muted); border:1px dashed var(--border); border-radius:10px; background:#f8fafc; }
    .footer { padding: 14px 20px; border-top:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .note { font-size:12px; color:var(--muted); }
    .summary { margin-top: 10px; border:1px solid var(--border); border-radius:12px; padding:12px; background:#fcfcfd; }
    .summary-title { font-weight:700; margin-bottom:6px; font-size:14px; }
    .summary-list { font-size:14px; line-height:1.6; }
    .toast { position: fixed; right: 16px; bottom: 16px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; font-size:13px; opacity:0; transform:translateY(8px); transition: all .25s ease; }
    .toast.show { opacity:1; transform:translateY(0); }
    .btn-area { margin-top: 16px; display:flex; gap:8px; justify-content:flex-start; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="card-header">
        <h1>랜덤 뽑기 (중복 허용 · 공용 잔여 차감)</h1>
        <div class="muted">형식: <code>이름 [잔여 N]</code> · “공용 잔여”는 서버에서 관리됩니다.</div>
      </div>
      <div class="card-body">
        <div class="row">
          <label for="choices">현재 잔여 (읽기 전용)</label>
          <textarea id="choices" placeholder="서버에서 잔여 목록을 불러옵니다." readonly></textarea>
          <div class="muted">※ 이 목록은 Netlify Functions를 통해 서버(Blobs)에서 불러옵니다.</div>
        </div>

        <div class="row">
          <label for="drawCount">결과 도출 개수 (1~50)</label>
          <div class="controls">
            <input id="drawCount" type="number" min="1" max="50" value="5" />
            <button class="primary" id="btnDraw">뽑기</button>
            <button id="btnRefresh">잔여 새로고침</button>
          </div>
          <div class="note">※ 추첨 시 공용 잔여 수량이 서버에서 차감됩니다.</div>
        </div>

        <div class="row">
          <label>결과</label>
          <div class="results" id="results">
            <div class="empty">아직 결과가 없습니다. “뽑기” 버튼을 눌러주세요.</div>
          </div>
        </div>

        <div class="btn-area">
          <button id="btnClear">직원확인란</button>
        </div>
      </div>
      <div class="footer">
        <div class="note">버전 1.8 · Netlify Functions 연동</div>
        <div class="note">공용 잔여 반영 · 결과 개수(1~50) · 오류 처리 강화</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    const choicesEl = document.getElementById('choices');
    const drawCountEl = document.getElementById('drawCount');
    const resultsEl = document.getElementById('results');
    const btnDraw = document.getElementById('btnDraw');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnClear = document.getElementById('btnClear');
    const toast = document.getElementById('toast');

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 1500);
    }

    // 1) 서버에서 현재 잔여 불러오기
    async function loadStock() {
      btnRefresh.disabled = true;
      try {
        const res = await fetch('/.netlify/functions/stock');
        if (!res.ok) throw new Error('fetch failed');
        const data = await res.json();
        const list = Array.isArray(data.stock) ? data.stock : [];
        if (!list.length) {
          choicesEl.value = '';
          resultsEl.innerHTML = '<div class="empty">서버에 등록된 잔여가 없습니다.</div>';
        } else {
          choicesEl.value = list.map(item => `${item.name} [잔여 ${item.remain}]`).join('\n');
        }
      } catch (e) {
        choicesEl.value = '';
        showToast('재고 불러오기 실패: 잠시 후 재시도하세요.');
      } finally {
        btnRefresh.disabled = false;
      }
    }

    // 2) 결과 표시(서버에서 받은 results 배열 사용)
    function renderResults(list) {
      resultsEl.innerHTML = '';
      if (!list?.length) { resultsEl.innerHTML = '<div class="empty">결과가 없습니다.</div>'; return; }
      const grid = document.createElement('div');
      grid.className = 'grid';
      list.forEach((item, i) => {
        const chip = document.createElement('div');
        chip.className = 'badge';
        chip.textContent = `${i + 1}. ${item}`;
        grid.appendChild(chip);
      });
      resultsEl.appendChild(grid);

      // 합계(동일 항목 중복 표기)
      const counts = Object.create(null); const order = [];
      for (const v of list) { if (!counts[v]) order.push(v); counts[v] = (counts[v] || 0) + 1; }
      const lines = order.map(k => counts[k] > 1 ? `${k}(${counts[k]})` : k);
      const summary = document.createElement('div');
      summary.className = 'summary';
      summary.innerHTML = `
        <div class="summary-title">합계</div>
        <div class="summary-list">${lines.map(l => `<div>${l}</div>`).join('')}</div>
      `;
      resultsEl.appendChild(summary);
    }

    // 3) 뽑기(서버 호출: 공용 잔여 차감)
    async function draw() {
      const count = Number(drawCountEl.value);
      if (!Number.isInteger(count) || count < 1 || count > 50) {
        alert('결과 도출 개수는 1~50 정수로 입력하세요.');
        return;
      }
      btnDraw.disabled = true;
      try {
        const res = await fetch('/.netlify/functions/stock?action=draw', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ count })
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok && data.ok) {
          renderResults(data.results);
          await loadStock(); // 최신 잔여 반영
          showToast('추첨 완료');
        } else {
          alert('❌ 뽑기 실패: ' + (data.reason || 'unknown'));
        }
      } catch (e) {
        alert('네트워크 오류로 요청에 실패했습니다.');
      } finally {
        // 한 번만 뽑게 두시려면 주석 해제하지 마세요.
        // 여러 번 뽑기 허용이면 다음 줄 주석 해제:
        // btnDraw.disabled = false;
      }
    }

    // 4) 초기화 버튼(화면만 초기화)
    function clearUI() {
      resultsEl.innerHTML = '<div class="empty">초기화되었습니다. 다시 뽑아주세요.</div>';
      // 필요 시 다시 뽑기 허용하려면 아래 주석 해제
      // btnDraw.disabled = false;
    }

    // 이벤트 바인딩
    btnRefresh.addEventListener('click', loadStock);
    btnDraw.addEventListener('click', draw);
    btnClear.addEventListener('click', clearUI);

    // 최초 진입 시 잔여 불러오기
    loadStock();
  </script>
</body>
</html>
